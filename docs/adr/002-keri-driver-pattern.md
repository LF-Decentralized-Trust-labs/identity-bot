# ADR 002: Python KERI Driver Pattern with keripy

**Date:** 2026-02-18
**Status:** Accepted
**Supersedes:** KERI-related sections of ADR 001

## Context

The Identity Agent needs a KERI (Key Event Receipt Infrastructure) protocol engine
to create inception events, manage Key Event Logs, and produce interoperable
CESR-encoded identifiers. The initial design (ADR 001) proposed embedding KERI
logic directly in the Go backend using a custom implementation.

After evaluating the output of that approach against the KERI specification, we
found that a custom implementation produces non-interoperable events — wrong CESR
prefix codes, SHA-256 instead of Blake3 SAIDs, and missing event fields. The
WebOfTrust `keripy` reference library (v1.1.17) is the most battle-tested KERI
implementation and produces spec-correct output.

However, keripy is a Python library. Embedding Python in a Go binary or in a
Flutter mobile app is impractical. We needed an architecture that uses keripy
without coupling it to the Go or Flutter processes.

## Decision

### 1. Internal HTTP Microservice ("Driver Pattern")

The Python KERI engine runs as a separate HTTP process on `127.0.0.1:9999`. The
Go Core communicates with it via HTTP requests. This is called the "Driver Pattern"
because the Python process acts as a hardware-like driver: the Go Core sends
commands, the driver executes KERI protocol operations, and returns results.

```
┌──────────────┐       HTTP        ┌──────────────────┐
│   Go Core    │ ───────────────── │  Python KERI      │
│  (port 5000) │  localhost:9999   │  Driver (keripy)  │
└──────────────┘                   └──────────────────┘
       ▲
       │ HTTP (port 5000)
       │
┌──────────────┐
│   Flutter    │
│   Frontend   │
└──────────────┘
```

### 2. keripy as a Hard Requirement (No Fallback)

The driver **requires** keripy and will refuse to start without it. This is a
deliberate choice: producing non-interoperable KERI events is worse than failing
loudly. There is no fallback implementation.

If keripy is not installed or libsodium is not available, the driver prints an
error and exits with a non-zero code. The Go Core detects this and reports the
failure via its health endpoint.

### 3. libsodium Detection for Nix Environments

keripy depends on `pysodium`, which requires `libsodium`. In Nix environments,
`ctypes.util.find_library("sodium")` often returns `None` because Nix doesn't
install libraries in standard system paths.

The driver uses a detection strategy:
1. Try `ctypes.util.find_library("sodium")` first (works on standard systems)
2. If that fails, try loading common `.so` names directly (`libsodium.so.26`, etc.)
3. If a load succeeds, inspect `/proc/<pid>/maps` to find the actual file path
4. Monkey-patch `ctypes.util.find_library` to return the discovered path for
   `sodium` lookups, so pysodium's initialization succeeds

### 4. Driver Lifecycle Management

The Go Core manages the Python driver's lifecycle:

- **Development (Replit/Linux):** Go spawns Python as a child process via
  `os/exec.Command()`. The process is killed when Go exits.
- **Production (Server):** Set `KERI_DRIVER_URL` environment variable. Go connects
  to that URL instead of spawning a child process.
- **Future Mobile:** Flutter on iOS/Android talks to Go over the internet. Go and
  the Python driver stay server-side. Mobile devices never run Python.

### 5. Driver API

The driver exposes two HTTP endpoints:

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/status` | GET | Health check and library info |
| `/inception` | POST | Create a KERI inception event from an Ed25519 key pair |

**POST /inception** request body:
```json
{
  "public_key": "<CESR-encoded Ed25519 public key>",
  "next_public_key": "<CESR-encoded Ed25519 next rotation key>"
}
```

**POST /inception** response body:
```json
{
  "aid": "<KERI Autonomic Identifier>",
  "inception_event": { "v": "KERI10JSON...", "t": "icp", ... },
  "public_key": "<CESR verfer qb64>",
  "next_key_digest": "<Blake3 digest of next key>"
}
```

## Consequences

### Positive

- **Spec compliance:** keripy produces CESR-encoded keys with correct prefix codes
  (`D` for Ed25519), Blake3 SAIDs, and proper event structure per KERI spec v1.0.
- **Interoperability:** Events generated by this system can be verified by any
  KERI-compliant implementation (KERIA, SignifyPy, etc.).
- **Mobile-ready:** The driver pattern means Flutter on mobile only needs HTTP
  access to the Go Core. No Python runtime on mobile devices.
- **Upgradeable:** When keripy releases new versions, only the Python driver needs
  updating. Go and Flutter are unaffected.
- **Testable:** The driver's HTTP API can be tested independently of Go or Flutter.

### Negative

- **Process management:** Go must spawn, monitor, and restart the Python process.
  This adds complexity to the backend.
- **Startup latency:** Python + keripy import adds ~2-3 seconds to cold start.
- **Hard dependency:** If keripy or libsodium is unavailable, the entire identity
  system is non-functional. There is no degraded mode.

### Risks

- **keripy API changes:** If the WebOfTrust team changes the keripy API, the
  driver's protocol helpers will need updating. Mitigated by pinning to v1.1.17.
- **libsodium detection fragility:** The `/proc/maps` inspection approach is
  Linux-specific. macOS and Windows would need different detection strategies.
  Acceptable because the driver only runs server-side (Linux in production).

## Environment Variables

| Variable | Default | Purpose |
|----------|---------|---------|
| `KERI_DRIVER_URL` | *(none)* | If set, Go connects to this URL instead of spawning Python |
| `KERI_DRIVER_PORT` | `9999` | Port for the managed Python driver |
| `KERI_DRIVER_SCRIPT` | `./drivers/keri-core/server.py` | Path to the driver script |
| `KERI_DRIVER_PYTHON` | `python3` | Python binary to use |
| `KERI_DRIVER_HOST` | `127.0.0.1` | Host the driver binds to |

## Key Files

- `drivers/keri-core/server.py` — The Python KERI driver (Flask HTTP server)
- `drivers/keri-core/requirements.txt` — Python dependencies (flask, keri)
- `identity-agent-core/drivers/keri_driver.go` — Go HTTP client for the driver
- `identity-agent-core/main.go` — Driver lifecycle management (spawn/connect)
